<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Dave - Blackjack</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile-first, full-screen layout, and aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        :root {
            --felt-green: #386641;
            --dark-bg: #1a202c;
            --card-red: #cc0000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; 
            width: 100vw; 
            padding: 0;
            margin: 0;
            overflow: hidden; 
        }

        #game-container {
            width: 100%;
            height: 100%; 
            max-width: 500px; 
            background-color: #2d3748;
            padding: 0.75rem; 
            display: flex;
            flex-direction: column;
            gap: 0.5rem; 
        }

        /* Card Styling */
        .card {
            width: 45px; 
            height: 70px;
            background-color: white;
            border-radius: 0.4rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            font-weight: 800;
            font-size: 1rem;
            margin: 0 3px;
            color: black;
            user-select: none;
            cursor: default;
            flex-shrink: 0;
        }
        .card-red { color: var(--card-red); }

        .card-back {
            background: linear-gradient(145deg, #a73737, #d94848);
            border: 2px solid gold;
        }

        .hand-display {
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px 0;
            overflow-x: auto; 
            white-space: nowrap; 
        }

        /* Felt table area - Constrained Height */
        .dealer-area, .player-area {
            background-color: var(--felt-green);
            border-radius: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #528c5e;
            height: 120px; 
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .player-area {
            border: 3px solid #f6e05e; 
        }
        
        /* Chip Styling - Circular chips kept for authenticity */
        .chip-button {
            width: 60px; 
            height: 60px;
            border-radius: 50%;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
            cursor: pointer;
            flex-shrink: 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chip-10 { background-color: #0080ff; color: white; }
        .chip-50 { background-color: #ffb800; color: black; }
        .chip-100 { background-color: #e53e3e; color: white; }
        .chip-500 { background-color: #000000; color: white; border: 2px solid gold; }

        /* Visual Bet Pile */
        #bet-pile {
            min-height: 40px; 
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            border: 1px dashed #555;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            position: relative;
            padding-top: 5px;
        }

        .bet-chip {
            width: 25px; 
            height: 25px;
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 25px;
            font-size: 0.6rem;
        }

        /* General Button Styling - Rounded Rectangles */
        .btn-base {
            @apply font-extrabold py-3 rounded-xl transition duration-200 shadow-xl transform active:scale-95 text-lg;
        }
        .btn-action {
            @apply btn-base bg-indigo-600 hover:bg-indigo-700 text-white;
        }
        .btn-disabled {
            @apply opacity-50 cursor-not-allowed;
        }

        /* Primary Action Buttons (DEAL/HIT/STAND/DOUBLE) - Increased height for thumb-clicking */
        .action-button-large {
            height: 75px; 
            @apply text-xl;
        }

        /* Betting amount display (Made much larger) */
        #current-betting-amount-display {
            @apply text-3xl font-black text-center text-yellow-300 tracking-wide mb-2;
        }
        
        /* Smaller buttons in the betting grid */
        #betting-controls button:not(#place-bet-btn):not(#new-game-btn) {
            height: 40px;
            @apply text-base;
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- Top Status Section -->
    <div class="flex flex-col gap-1 flex-shrink-0">
        <h1 class="text-2xl font-black text-center text-yellow-400 tracking-wider">BLACK DAVE</h1>
        
        <!-- Chip/Bet/High Score Status -->
        <div class="grid grid-cols-3 gap-2 text-xl font-black bg-gray-800 p-2 rounded-lg border border-gray-700">
            <!-- CHIPS -->
            <div class="flex flex-col items-start">
                <span class="text-xs uppercase text-gray-400">CHIPS</span>
                <span id="chips-display" class="animated-value text-green-400">$2,000</span>
            </div>
           <!-- YouTube Player Section - Centered Right and Larger -->
<div id="youtube-container" class="fixed top-1/2 right-5 -translate-y-1/2 w-[400px] h-[250px] bg-black rounded-xl shadow-2xl border-4 border-yellow-400 z-50">
    <div id="youtube-player" class="w-full h-full rounded-lg"></div>
    <button id="close-youtube-btn" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-51">âœ•</button>
</div>

<!-- YouTube Link Input (Optional) -->
<div id="youtube-input-panel" class="fixed bottom-4 left-4 bg-gray-800 p-3 rounded-lg border-2 border-yellow-400 z-50" style="display: none;">
    <input type="text" id="youtube-url-input" placeholder="Enter YouTube URL" class="w-full px-2 py-1 rounded text-black text-sm mb-2">
    <button id="load-youtube-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm font-bold">Load Video</button>
</div>

<!-- Toggle Button -->
<button id="toggle-youtube-btn" class="fixed top-4 right-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold z-40">ðŸ“º YouTube</button>

            <!-- HIGH SCORE -->
            <div class="flex flex-col items-center">
                <span class="text-xs uppercase text-gray-400">HIGH SCORE</span>
                <span id="high-score-display" class="text-yellow-400">$2,000</span>
            </div>

            <!-- CURRENT WAGER -->
            <div class="flex flex-col items-end">
                <span class="text-xs uppercase text-gray-400">WAGER</span>
                <span id="current-wager-display" class="text-yellow-300">$0</span>
            </div>
        </div>

        <!-- Game Message Area -->
        <div id="message-box" class="h-8 text-center text-sm font-extrabold rounded-lg flex items-center justify-center border-2 border-gray-700">
            Place your bet or press DEAL.
        </div>
    </div>

    <!-- Game Table Area (Constrained Height) -->
    <div class="flex-shrink-0 flex flex-col gap-1">
        <!-- Dealer Hand -->
        <div class="dealer-area">
            <h2 class="text-sm font-bold text-gray-200 mb-1 text-center">DEALER (<span id="dealer-score-display">?</span>)</h2>
            <div id="dealer-hand" class="hand-display">
                <!-- Dealer cards go here -->
            </div>
        </div>

        <!-- Player Hand -->
        <div class="player-area">
            <h2 class="text-sm font-bold text-gray-100 mb-1 text-center">PLAYER (<span id="player-score-display">0</span>)</h2>
            <div id="player-hand" class="hand-display">
                <!-- Player cards go here -->
            </div>
        </div>
    </div>
    
    <!-- PRIMARY ACTION ROW (HIT, STAND, DOUBLE, DEAL, NEW ROUND) -->
    <div id="primary-action-row" class="flex-shrink-0 mt-2">
        
        <!-- Game Action Buttons (Hit, Stand, Double) -->
        <div id="action-controls" class="flex justify-between gap-2" style="display: none;">
            
            <!-- Left: DOUBLE -->
            <button id="double-btn" class="btn-base action-button-large bg-yellow-600 hover:bg-yellow-700 text-gray-900 w-1/3">DOUBLE</button>

            <!-- Right: HIT & STAND grouped -->
            <div class="flex w-2/3 gap-2">
                <button id="hit-btn" class="btn-action action-button-large w-1/2">HIT</button>
                <button id="stand-btn" class="btn-action action-button-large w-1/2">STAND</button>
            </div>
        </div>

        <!-- Betting/New Round Action Button Holder (DEAL/NEW ROUND) -->
        <div id="bet-deal-controls" style="display: block;">
            <!-- Primary DEAL button - Orange and Thumb Friendly -->
            <button id="place-bet-btn" class="btn-base action-button-large bg-orange-500 hover:bg-orange-600 text-white w-full">DEAL</button>

            <!-- New Game Button (Hidden until game end) -->
            <button id="new-game-btn" class="btn-base action-button-large bg-yellow-500 hover:bg-yellow-600 text-gray-900 w-full" style="display: none;">NEW ROUND</button>
        </div>
    </div>

    <!-- BETTING CONTROLS (MOVED UP) -->
    <div id="betting-controls" class="flex flex-col gap-1 mt-3">
        
        <!-- Bigger, Clearer Betting Amount Display -->
        <div id="current-betting-amount-display">
            BET: <span id="current-betting-display">$0</span>
        </div>
        
        <!-- Action Buttons for Betting (Clear/Repeat) -->
        <div class="flex justify-center gap-2 mb-2">
            <button id="clear-bet-btn" class="btn-base bg-gray-600 hover:bg-gray-500 text-white w-2/5">CLEAR</button>
            <button id="repeat-bet-btn" class="btn-base bg-green-600 hover:bg-green-700 text-white w-2/5">REPEAT LAST ($<span id="repeat-amount-display">0</span>)</button>
        </div>
        
        <!-- Visual Bet Pile -->
        <div id="bet-pile" class="mb-2"></div>
        
        <!-- Chip Denomination Buttons -->
        <div class="flex justify-center gap-2 mt-2 mb-1">
            <button class="chip-button chip-10" onclick="addChipToBet(10)">10</button>
            <button class="chip-button chip-50" onclick="addChipToBet(50)">50</button>
            <button class="chip-button chip-100" onclick="addChipToBet(100)">100</button>
            <button class="chip-button chip-500" onclick="addChipToBet(500)">500</button>
        </div>
    </div>

</div>

<script>
    const SUITS = ['â™¥', 'â™¦', 'â™£', 'â™ '];
    const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    const CHIP_DENOMINATIONS = [500, 100, 50, 10]; 

    let chips = 2000;
    let highScore = 0; 
    let currentBet = 0; 
    let currentBettingAmount = 0; 
    let lastBetAmount = 0; 
    let deck = [];
    let playerHand = [];
    let dealerHand = [];
    let isGameActive = false;
    let canDoubleDown = false; 

    // DOM Elements
    const chipsDisplay = document.getElementById('chips-display');
    const highScoreDisplay = document.getElementById('high-score-display'); 
    const currentWagerDisplay = document.getElementById('current-wager-display'); 
    const currentBettingDisplay = document.getElementById('current-betting-display'); 
    const repeatAmountDisplay = document.getElementById('repeat-amount-display'); 
    const messageBox = document.getElementById('message-box');
    const dealerHandEl = document.getElementById('dealer-hand');
    const playerHandEl = document.getElementById('player-hand');
    const dealerScoreDisplay = document.getElementById('dealer-score-display');
    const playerScoreDisplay = document.getElementById('player-score-display');
    
    // Control Group References
    const bettingControls = document.getElementById('betting-controls');
    const actionControls = document.getElementById('action-controls');
    const betDealControls = document.getElementById('bet-deal-controls');
    
    const placeBetBtn = document.getElementById('place-bet-btn');
    const hitBtn = document.getElementById('hit-btn');
    const standBtn = document.getElementById('stand-btn');
    const doubleBtn = document.getElementById('double-btn');
    const newGameBtn = document.getElementById('new-game-btn');
    const clearBetBtn = document.getElementById('clear-bet-btn');
    const repeatBetBtn = document.getElementById('repeat-bet-btn');
    const betPileEl = document.getElementById('bet-pile');

    // --- Utility Functions ---

    /** Converts a number to a currency string */
    const formatCurrency = (amount) => {
        return '$' + amount.toLocaleString('en-US');
    };

    // --- High Score Logic ---

    /** Loads high score from local storage or initializes it */
    function loadHighScore() {
        const storedScore = localStorage.getItem('blackjackHighScore');
        if (storedScore && !isNaN(parseInt(storedScore, 10))) {
            highScore = parseInt(storedScore, 10);
        } else {
            // Set initial high score to starting chips
            highScore = chips; 
            localStorage.setItem('blackjackHighScore', chips);
        }
    }
    
    /** Checks and updates the high score if the current chip count is higher */
    function updateHighScore() {
        if (chips > highScore) {
            highScore = chips;
            localStorage.setItem('blackjackHighScore', chips);
            highScoreDisplay.textContent = formatCurrency(highScore);
            // Flash a quick message for a new high score
            showMessage("NEW HIGH SCORE! " + formatCurrency(highScore), false);
        } else {
            highScoreDisplay.textContent = formatCurrency(highScore);
        }
    }


    /** Creates a standard 52-card deck and shuffles it */
    function createDeck() {
        deck = [];
        for (const suit of SUITS) {
            for (const rank of RANKS) {
                let value;
                if (['K', 'Q', 'J'].includes(rank)) {
                    value = 10;
                } else if (rank === 'A') {
                    value = 11;
                } else {
                    value = parseInt(rank);
                }
                deck.push({ rank, suit, value });
            }
        }
        // Fisher-Yates shuffle
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    /** Deals the next card from the deck */
    function dealCard() {
        if (deck.length === 0) {
            createDeck(); 
        }
        return deck.pop();
    }

    /** Calculates the score of a given hand, handling Aces */
    function calculateScore(hand) {
        let score = 0;
        let aceCount = 0;

        for (const card of hand) {
            if (card.rank === 'A') {
                aceCount++;
                score += 11;
            } else {
                score += card.value;
            }
        }

        while (score > 21 && aceCount > 0) {
            score -= 10;
            aceCount--;
        }

        return score;
    }

    /** Generates the HTML for a single card */
    function createCardElement(card, isFaceDown = false) {
        const suitColorClass = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'card-red' : 'card-black';

        if (isFaceDown) {
            return `<div class="card card-back">BACK</div>`;
        }

        return `
            <div class="card ${suitColorClass}">
                <span class="text-sm">${card.rank}</span>
                <span class="text-2xl" style="line-height: 1;">${card.suit}</span>
                <span class="text-sm transform rotate-180">${card.rank}</span>
            </div>
        `;
    }

    /** Renders the hands and updates scores on the UI */
    function renderHands(revealDealer = false) {
        playerHandEl.innerHTML = playerHand.map(card => createCardElement(card)).join('');
        playerScoreDisplay.textContent = calculateScore(playerHand);

        if (isGameActive && !revealDealer) {
            const firstCard = createCardElement(dealerHand[0]);
            const hiddenCard = createCardElement(dealerHand[1], true);
            dealerHandEl.innerHTML = firstCard + hiddenCard;
            dealerScoreDisplay.textContent = calculateScore([dealerHand[0]]);
        } else {
            dealerHandEl.innerHTML = dealerHand.map(card => createCardElement(card)).join('');
            dealerScoreDisplay.textContent = calculateScore(dealerHand);
        }

        // Control Double Down button state
        if (isGameActive && canDoubleDown && chips >= currentBet) {
             doubleBtn.classList.remove('btn-disabled');
             doubleBtn.disabled = false;
        } else {
            doubleBtn.classList.add('btn-disabled');
            doubleBtn.disabled = true;
        }
        
        // Update current wager display (in the status bar)
        currentWagerDisplay.textContent = formatCurrency(currentBet);
    }

    /** Renders the visual chip stack in the bet pile */
    function renderBetPile() {
        betPileEl.innerHTML = '';
        currentBettingDisplay.textContent = formatCurrency(currentBettingAmount);
        repeatAmountDisplay.textContent = lastBetAmount; // Update repeat button with actual amount
        
        // Control DEAL and REPEAT button state
        const isBetValid = currentBettingAmount >= 10;
        const affordableLastBet = lastBetAmount <= chips;

        // Enable/Disable DEAL button based on current staged bet
        if (isBetValid) {
            placeBetBtn.classList.remove('btn-disabled');
            placeBetBtn.disabled = false;
        } else {
            placeBetBtn.classList.add('btn-disabled');
            placeBetBtn.disabled = true;
        }

        // Enable/Disable REPEAT button
        if (lastBetAmount >= 10 && affordableLastBet) {
            repeatBetBtn.classList.remove('btn-disabled');
            repeatBetBtn.disabled = false;
        } else {
            repeatBetBtn.classList.add('btn-disabled');
            repeatBetBtn.disabled = true;
        }

        if (currentBettingAmount === 0) return;


        let tempAmount = currentBettingAmount;
        const maxChipsToDisplay = 8; 
        let chipStack = [];
        
        // Greedy algorithm to break down the amount into denominations
        for (const value of CHIP_DENOMINATIONS) {
            while (tempAmount >= value) {
                chipStack.push(value);
                tempAmount -= value;
            }
        }
        
        chipStack.reverse(); // Stack smaller chips on top
        
        const displayStack = chipStack.slice(0, maxChipsToDisplay);

        displayStack.forEach((value, index) => {
            const chipEl = document.createElement('div');
            chipEl.className = `bet-chip chip-${value}`;
            chipEl.textContent = value;
            chipEl.style.zIndex = index + 1;
            chipEl.style.bottom = `${(index * 3) + 3}px`; 
            chipEl.style.left = '50%';
            chipEl.style.transform = 'translateX(-50%)'; 

            betPileEl.appendChild(chipEl);
        });
        
        // Add total display for larger stacks
        if (chipStack.length > maxChipsToDisplay) {
             const chipEl = document.createElement('div');
             chipEl.className = `bet-chip chip-500`;
             chipEl.textContent = "SUM";
             chipEl.style.backgroundColor = '#999';
             chipEl.style.color = 'black';
             chipEl.style.zIndex = maxChipsToDisplay + 1;
             chipEl.style.bottom = `${(maxChipsToDisplay * 3) + 3}px`; 
             chipEl.style.left = '50%';
             chipEl.style.transform = 'translateX(-50%)';
             betPileEl.appendChild(chipEl);
        }
    }

    /** Updates the chips and bet UI with subtle animation */
    function updateUI() {
        const oldChips = parseInt(chipsDisplay.textContent.replace('$', '').replace(/,/g, '')) || 0;
        
        // Chips animation
        if (chips !== oldChips) {
            if (chips > oldChips) {
                chipsDisplay.classList.add('text-green-300', 'scale-110');
            } else {
                chipsDisplay.classList.add('text-red-400', 'scale-90');
            }
            chipsDisplay.textContent = formatCurrency(chips);
            setTimeout(() => {
                chipsDisplay.classList.remove('text-green-300', 'text-red-400', 'scale-110', 'scale-90');
                chipsDisplay.classList.add('text-green-400');
            }, 500);
        } else {
            chipsDisplay.textContent = formatCurrency(chips);
        }
        
        // Always check high score when chips change
        updateHighScore(); 

        // Update last bet display and repeat button
        renderBetPile();
    }

    /** Updates the game message box */
    function showMessage(msg, isError = false) {
        messageBox.textContent = msg;
        messageBox.className = 'h-8 text-center text-sm font-extrabold rounded-lg flex items-center justify-center border-2';
        if (isError) {
            messageBox.classList.add('bg-red-800', 'text-white', 'border-red-600');
        } else {
            messageBox.classList.add('bg-gray-700', 'text-yellow-300', 'border-yellow-500');
        }
    }

    // --- Betting Functions ---

    /** Adds a chip of specific value to the staged bet */
    function addChipToBet(value) {
        if (isGameActive) return;
        if (currentBettingAmount + value > chips) {
            currentBettingAmount = chips;
            return showMessage(`Bet capped at your remaining chips: ${formatCurrency(chips)}.`, true);
        }

        currentBettingAmount += value;
        updateUI();
    }
    
    /** Clears the staged bet */
    function clearBet() {
        if (isGameActive) return;
        currentBettingAmount = 0;
        updateUI();
        showMessage('Bet cleared. Place new chips.');
    }

    /** Repeat the last bet amount */
    function repeatLastBet(showMsg = true) {
        if (isGameActive) return;
        
        const affordableBet = Math.min(lastBetAmount, chips);
        
        if (affordableBet < 10) {
            currentBettingAmount = 0;
            return showMessage("Not enough chips for the minimum bet ($10).", true);
        }

        currentBettingAmount = affordableBet;
        updateUI();
        if (showMsg) showMessage(`Bet set to previous amount: ${formatCurrency(currentBettingAmount)}.`);
    }

    // --- Game Logic ---

    /** Starts a new round, resetting state and UI */
    function resetRound() {
        playerHand = [];
        dealerHand = [];
        isGameActive = false;
        canDoubleDown = false;
        currentBet = 0;
        
        // Stage the last bet amount automatically if possible
        if (lastBetAmount > 0 && chips >= lastBetAmount) {
             currentBettingAmount = lastBetAmount; 
        } else {
            // Default to $100 or max chips
            currentBettingAmount = Math.min(100, chips); 
        }
        if (currentBettingAmount < 10 && chips >= 10) { 
            // Ensure minimum bet is always staged if player can afford it
            currentBettingAmount = 10;
        } else if (chips < 10) { 
            // If player has less than min bet
            currentBettingAmount = 0;
        }

        updateUI();
        renderHands();

        // CONTROL VISIBILITY for betting state
        actionControls.style.display = 'none';
        newGameBtn.style.display = 'none';
        betDealControls.style.display = 'block';
        placeBetBtn.style.display = 'block';
        // bettingControls is always visible, but the Deal/Action buttons control flow

        playerScoreDisplay.textContent = 0;
        dealerScoreDisplay.textContent = '?';
        currentWagerDisplay.textContent = formatCurrency(0);
        showMessage('Place your bet or press DEAL.');
    }

    /** Handles the betting process and deals cards */
    function placeBet() {
        const betAmount = currentBettingAmount;

        if (betAmount < 10) {
            return showMessage('Minimum bet is $10.', true);
        }
        if (betAmount > chips) {
            return showMessage("Cannot bet more than you have!", true);
        }

        // Finalize bet
        chips -= betAmount;
        currentBet = betAmount;
        lastBetAmount = betAmount; 
        currentBettingAmount = 0; 
        isGameActive = true;
        canDoubleDown = true; 
        updateUI();

        // CONTROL VISIBILITY for game active state
        betDealControls.style.display = 'none';
        actionControls.style.display = 'flex';

        dealInitialCards();
    }

    /** Deals the first two cards and checks for immediate Blackjack */
    function dealInitialCards() {
        createDeck();
        playerHand.push(dealCard());
        dealerHand.push(dealCard());
        playerHand.push(dealCard());
        dealerHand.push(dealCard());

        renderHands();

        const playerScore = calculateScore(playerHand);
        const dealerScore = calculateScore(dealerHand);

        if (playerScore === 21) {
            canDoubleDown = false; 
            if (dealerScore === 21) {
                showMessage("Push! Both have Blackjack.", false);
                endRound(0); 
            } else {
                showMessage("Blackjack! You win 3:2!", false);
                endRound(1.5); 
            }
        } else if (dealerScore === 21) {
            canDoubleDown = false; 
            showMessage("Dealer Blackjack. You lose.", true);
            endRound(-1); 
        }
    }

    /** Player chooses to hit */
    function hit() {
        if (!isGameActive) return;
        canDoubleDown = false; 
        
        playerHand.push(dealCard());
        renderHands();
        const score = calculateScore(playerHand);

        if (score > 21) {
            showMessage("Bust! Your score is " + score + ". You lose.", true);
            endRound(-1);
        }
    }

    /** Player chooses to Double Down */
    function doubleDown() {
        if (!isGameActive || !canDoubleDown) return;
        
        if (chips < currentBet) {
            return showMessage("Not enough chips to double down.", true);
        }

        chips -= currentBet;
        currentBet *= 2;
        updateUI();

        canDoubleDown = false;
        playerHand.push(dealCard());
        renderHands();

        const score = calculateScore(playerHand);

        if (score > 21) {
            showMessage("Bust on Double Down! Score: " + score + ". You lose.", true);
            endRound(-1);
        } else {
            showMessage("Double Down: New score " + score + ". Stand enforced.", false);
            stand(); 
        }
    }

    /** Player chooses to stand */
    function stand() {
        if (!isGameActive) return;

        actionControls.style.display = 'none';
        canDoubleDown = false; 
        isGameActive = false;
        dealerPlay();
    }

    /** Dealer plays their hand until 17 or more */
    function dealerPlay() {
        renderHands(true); 
        let dealerScore = calculateScore(dealerHand);
        const playerScore = calculateScore(playerHand);

        const dealerTurnInterval = setInterval(() => {
            if (dealerScore < 17) {
                dealerHand.push(dealCard());
                renderHands(true);
                // MUST recalculate score after drawing card
                dealerScore = calculateScore(dealerHand); 
            } else {
                clearInterval(dealerTurnInterval);
                determineWinner(playerScore, dealerScore); 
            }
        }, 800); 
    }

    /** Determines the winner and handles payouts */
    function determineWinner(pScore, dScore) {
        let payoutMultiplier = 0;
        let message = '';

        if (dScore > 21) {
            message = "Dealer Busts! You Win!";
            payoutMultiplier = 1;
        } else if (pScore > dScore) {
            message = "You Win! Score: " + pScore;
            payoutMultiplier = 1;
        } else if (pScore < dScore) {
            message = "Dealer Wins. Score: " + dScore;
            payoutMultiplier = -1;
        } else {
            message = "Push! It's a tie.";
            payoutMultiplier = 0;
        }

        showMessage(message, payoutMultiplier < 0);
        endRound(payoutMultiplier);
    }

    /** Ends the round, processes chips, and updates UI for next round */
    function endRound(multiplier) {
        isGameActive = false;
        
        if (multiplier > 0) {
            chips += currentBet + (currentBet * multiplier); 
        } else if (multiplier === 0) {
            chips += currentBet; 
        } 

        currentBet = 0;
        updateUI(); // Calls updateHighScore() internally

        // CONTROL VISIBILITY for game end state
        actionControls.style.display = 'none';
        betDealControls.style.display = 'block';

        // Game Over Check
        if (chips < 10) {
             showMessage("GAME OVER! You ran out of chips. Time to restart.", true);
            newGameBtn.textContent = 'RESTART ($2,000)';
            placeBetBtn.style.display = 'none';
            newGameBtn.style.display = 'block';
            // Reset chips to $2000 on restart
            newGameBtn.onclick = () => { chips = 2000; lastBetAmount = 0; resetRound(); };
        } else {
            newGameBtn.textContent = 'NEW ROUND';
            placeBetBtn.style.display = 'none';
            newGameBtn.style.display = 'block';
            newGameBtn.onclick = resetRound;
        }
    }

    // --- Initialization and Event Listeners ---

    window.onload = function() {
        // 1. Load the persistent High Score
        loadHighScore(); 
        
        // 2. Set up event listeners
        clearBetBtn.addEventListener('click', clearBet);
        repeatBetBtn.addEventListener('click', repeatLastBet);
        placeBetBtn.addEventListener('click', placeBet);
        hitBtn.addEventListener('click', hit);
        standBtn.addEventListener('click', stand);
        doubleBtn.addEventListener('click', doubleDown); 
        
        // 3. Final setup
        updateUI(); // Renders initial chips, high score, and betting buttons
        resetRound();
    };
    // --- Keyboard Controls ---
document.addEventListener('keydown', function(event) {
    // Spacebar triggers DEAL, HIT, or NEW ROUND depending on game state
    if (event.code === 'Space') {
        event.preventDefault(); // Prevent page scroll
        
        if (newGameBtn.style.display === 'block') {
            // Game Over state - trigger NEW ROUND/RESTART
            newGameBtn.click();
        } else if (hitBtn.style.display !== 'none' && actionControls.style.display === 'flex') {
            // During game - trigger HIT
            hit();
        } else if (placeBetBtn.style.display === 'block') {
            // Betting state - trigger DEAL
            placeBet();
        }
    }
    
    // Enter key triggers STAND
    if (event.code === 'Enter') {
        event.preventDefault(); // Prevent form submission
        
        if (standBtn.style.display !== 'none' && actionControls.style.display === 'flex') {
            // During game - trigger STAND
            stand();
        }
    }
});
// --- YouTube Integration ---

let youtubePlayerReady = false;

function loadYouTubeAPI() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

function onYouTubeIframeAPIReady() {
    youtubePlayerReady = true;
}

function getYouTubeVideoID(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function loadYouTubeVideo(url) {
    const videoID = getYouTubeVideoID(url);
    
    if (!videoID) {
        alert('Invalid YouTube URL');
        return;
    }
    
    const youtubeContainer = document.getElementById('youtube-player');
    youtubeContainer.innerHTML = `
        <iframe 
            width="100%" 
            height="100%" 
            src="https://www.youtube.com/embed/${videoID}?autoplay=1" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
        </iframe>
    `;
    
    document.getElementById('youtube-container').style.display = 'block';
}

// Event Listeners for YouTube Controls
document.getElementById('toggle-youtube-btn').addEventListener('click', () => {
    const inputPanel = document.getElementById('youtube-input-panel');
    inputPanel.style.display = inputPanel.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('load-youtube-btn').addEventListener('click', () => {
    const url = document.getElementById('youtube-url-input').value;
    if (url) {
        loadYouTubeVideo(url);
        document.getElementById('youtube-input-panel').style.display = 'none';
    }
});

document.getElementById('close-youtube-btn').addEventListener('click', () => {
    document.getElementById('youtube-container').style.display = 'none';
});

// Load YouTube API on page load
window.addEventListener('load', loadYouTubeAPI);

</script>

</body>
</html>
